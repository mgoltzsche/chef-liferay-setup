#!/bin/bash
if [ -z "$LIFERAY_HOME" ]; then
	LIFERAY_HOME='<%=@home%>'
fi

if [ -z "$LIFERAY_USER" ]; then
	LIFERAY_USER='<%=@user%>'
fi

ACTION="$1"
BAK="$2"
CFG_FILE="$LIFERAY_HOME/portal-ext.properties"

if [ -z "$BAK" ]; then
	echo "Usage: $0 {dump|restore} DIRECTORY"
	exit 1
fi

function doWithShards {
	for SHARD in $(cat $CFG_FILE | grep -P '^jdbc\.[^\.]+\.url='); do
		SHARD_NAME=$(echo $SHARD | grep -Po '(?<=^jdbc\.)[^\.]+')
		SHARD_DB=$(echo $SHARD | grep -Po '[^/]+$')
		SHARD_DB_USER=$(cat $CFG_FILE | grep -Po "(?<=^jdbc\.$SHARD_NAME\.username=).*")

		if [ -z "$SHARD_NAME" ] || [ -z "$SHARD_DB" ] || [ -z "$SHARD_DB_USER" ]; then
			echo "! Invalid shard configuration at shard '$SHARD'. Check $CFG_FILE"
			return 1
		fi

		doWithShard "$SHARD_DB" "$SHARD_DB_USER"

		STATUS=$?

		if [ $STATUS != '0' ]; then
			return 1
		fi
	done
}

function doWithShard {
	backupPostgreDB $ACTION "$1" "$BAK/sql/$1.sql" "$2"
}

function liferayBackup {
	doWithShards &&
	backupDirectory $ACTION "$LIFERAY_HOME/data" "$BAK/data" "$LIFERAY_USER:$LIFERAY_USER" &&
	backupFile      $ACTION "$CFG_FILE"          "$BAK/portal-ext.properties" "$LIFERAY_USER:$LIFERAY_USER" 640
}

case "$ACTION" in
	dump)
		liferayBackup
	;;
	restore)
		serviceWrapper liferay stop
		liferayBackup &&
		serviceWrapper liferay start
	;;
	*)
		echo "Usage: $0 {dump|restore} DIRECTORY"
		exit 1
	;;
esac
