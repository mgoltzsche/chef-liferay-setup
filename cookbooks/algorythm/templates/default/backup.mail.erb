#!/bin/bash

if [ -z "$VMAIL_HOME" ]; then
	VMAIL_HOME='<%=@home%>'
fi
if [ -z "$VMAIL_USER" ]; then
	VMAIL_USER='<%=@user%>'
fi

ACTION="$1"
BAK="$2"

if [ -z "$BAK" ]; then
	echo "Usage: $0 {dump|restore} DIRECTORY"
	exit 1
fi

function mailBackup {
	backupFile      $ACTION '/etc/postfix/main.cf'                      'etc/postfix/main.cf' &&
	backupFile      $ACTION '/etc/postfix/master.cf'                    'etc/postfix/master.cf' &&
	backupFile      $ACTION '/etc/postfix/dynamicmaps.cf'               'etc/postfix/dynamicmaps.cf' &&
	backupDirectory $ACTION '/etc/postfix/ldap'                         'etc/postfix/ldap' root:postfix &&
	backupFile      $ACTION '/etc/dovecot/dovecot.conf'                 'etc/dovecot/dovecot.conf' root:root &&
	backupFile      $ACTION '/etc/dovecot/dovecot-ldap.conf.ext'        'etc/dovecot/dovecot-ldap.conf.ext' root:root &&
	backupFile      $ACTION '/etc/dovecot/dovecot-ldap-userdb.conf.ext' 'etc/dovecot/dovecot-ldap-userdb.conf.ext' root:root &&
	backupDirectory $ACTION "$VMAIL_HOME"                               'vmail' "$VMAIL_USER:$VMAIL_USER"
}

case "$ACTION" in
	dump)
		mailBackup
	;;
	restore)
		serviceWrapper postfix stop
		serviceWrapper dovecot stop
		mailBackup &&
		serviceWrapper dovecot start &&
		serviceWrapper postfix start
	;;
	*)
		echo "Usage: $0 {dump|restore} DIRECTORY"
		exit 1
	;;
esac
