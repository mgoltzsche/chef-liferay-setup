#!/bin/bash
#################################################################################
# Usage: backup-file.sh {dump FILE BAK|restore FILE BAK [OWNER[, PERMISSIONS]]} #
# Must be run as root                                                           #
#################################################################################

if [ $(id -u) != '0' ]; then
	echo 'You need root privileges to run this script' 2>&1
	exit 1
fi

SCRIPT_NAME="$0"
ACTION="$1"
FILE="$2"
FILE_BAK="$3"
OWNER="$4"
PERMISSIONS="$5"

if [ -z "$OWNER" ]; then
	OWNER='root'
fi

if [ -z "$PERMISSIONS" ]; then
	PERMISSIONS='600'
fi

case "$ACTION" in
	dump|restore)
	;;
	*)
		echo "Usage: $SCRIPT_NAME {dump FILE BAK|restore FILE BAK [OWNER[, PERMISSIONS]]}"
		exit 1
	;;
esac

if [ -z "$FILE" ] || [ -z "$FILE_BAK" ]; then
	echo "Usage: $SCRIPT_NAME {dump FILE BAK|restore FILE BAK [OWNER[, PERMISSIONS]]}"
	exit 1
fi


echo "* $ACTION file $FILE"

case "$ACTION" in
	dump)
		mkdir -p $(dirname "$FILE_BAK") &&
		cp "$FILE" "$FILE_BAK"
	;;
	restore)
		if [ -z "$OWNER" ]; then
			echo "Usage: $SCRIPT_NAME restore FILE BAK [OWNER[, PERMISSIONS]]"
			exit 1
		fi
		
		rm -f "$FILE" &&
		cp "$FILE_BAK" "$FILE" &&
		chown -R "$OWNER:$OWNER" "$FILE" &&
		chmod -R $PERMISSIONS "$FILE"
	;;
esac
