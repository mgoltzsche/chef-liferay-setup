#!/bin/bash

function ldapBackup {
	EXIT_CODE=0
	
	for INSTANCE in $(ls "$LOOP_DIR" | grep -P "^slapd-"); do
		backupDirectory "/etc/dirsrv/$INSTANCE" "conf/$INSTANCE" dirsrv:dirsrv &&
		backupDirectory "/var/lib/dirsrv/$INSTANCE" "data/$INSTANCE" dirsrv:dirsrv
		STATUS=$?

		if [ $STATUS != '0' ]; then
			EXIT_CODE=2
		fi
	done
	return $EXIT_CODE
}

case "$ACTION" in
	dump)
		LOOP_DIR=/etc/dirsrv
		ldapBackup
	;;
	restore)
		LOOP_DIR="$BACKUP_TMP_DIR/conf"
		serviceWrapper dirsrv stop
		ldapBackup &&
		serviceWrapper dirsrv start
	;;
	*)
		echo "Usage: $0 {dump|restore} DIRECTORY"
		exit 1
	;;
esac
