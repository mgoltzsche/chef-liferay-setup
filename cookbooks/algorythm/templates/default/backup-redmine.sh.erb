#!/bin/bash
#####################################################
# Usage: backup-redmine.sh {dump|restore} DIRECTORY #
# Must be run as root                               #
#####################################################

if [ -z "$REDMINE_INSTALLATION" ]; then
	REDMINE_INSTALLATION='<%=@dir%>'
fi
if [ -z "$REDMINE_HOME" ]; then
	REDMINE_HOME='<%=@homeDir%>'
fi

if [ -z "$REDMINE_USER" ]; then
	REDMINE_USER='<%=@user%>'
fi

SCRIPT_NAME="$0"
ACTION="$1"
BAK="$2"

DB_CFG_FILE="$REDMINE_INSTALLATION/config/database.yml"
DB_NAME=$(cat $DB_CFG_FILE | grep -Po "(?<=database:\s).*")
DB_USER=$(cat $DB_CFG_FILE | grep -Po "(?<=username:\s).*")

if [ -z "$BAK" ]; then
	echo "Usage: $SCRIPT_NAME {dump|restore} DIRECTORY"
	exit 1
fi

case "$ACTION" in
	dump)
		backup-pg    dump "$DB_NAME" "$BAK/db.sql" &&
		backup-directory dump "$REDMINE_HOME/files" "$BAK/files"
	;;
	restore)
		echo '* stop thin'
		service thin stop >> /dev/null
		backup-pg    restore "$DB_NAME" "$BAK/db.sql" "$DB_USER" &&
		backup-directory restore "$REDMINE_HOME/files" "$BAK/files" "$REDMINE_USER" &&
		echo '* migrate database' &&
		su "$REDMINE_USER" -c "cd \"$REDMINE_INSTALLATION\"; PATH=$PATH:$(/usr/local/rvm/bin/rvm gemdir)/bin:/usr/local/rvm/bin; export RAILS_ENV=production; rake db:migrate" &&
		echo '* reconfigure backlogs plugin' &&
		su "$REDMINE_USER" -c "cd \"$REDMINE_INSTALLATION\"; PATH=$PATH:$(/usr/local/rvm/bin/rvm gemdir)/bin:/usr/local/rvm/bin; export RAILS_ENV=production; rake redmine:backlogs:install" &&
		echo '* start thin' &&
		service thin start >> /dev/null
	;;
	*)
		echo "Usage: $SCRIPT_NAME {dump|restore} DIRECTORY"
		exit 1
	;;
esac
