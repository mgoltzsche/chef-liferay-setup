#!/bin/bash
###################################################
# Usage: backup-nexus.sh {dump|restore} DIRECTORY #
# Must be run as root                             #
###################################################

if [ -z "$NEXUS_HOME" ]; then
	NEXUS_HOME='<%=@home%>'
fi
if [ -z "$NEXUS_SYSTEM_USER" ]; then
	NEXUS_SYSTEM_USER='<%=@user%>'
fi

SCRIPT_NAME="$0"
ACTION="$1"
BAK="$2"

if [ -z "$BAK" ]; then
	echo "Usage: $SCRIPT_NAME {dump|restore} DIRECTORY"
	exit 1
fi

case "$ACTION" in
	dump)
		backup-directory dump "$NEXUS_HOME" "$BAK/files" &&
		rm -rf "$BAK/files/logs" &&
		rm -rf "$BAK/files/indexer" &&
		rm -rf "$BAK/files/timeline" &&
		rm -rf "$BAK/files/storage/codehaus-snapshots" &&
		rm -rf "$BAK/files/storage/apache-snapshots" &&
		rm -rf "$BAK/files/storage/central"
	;;
	restore)
		service-wrapper liferay stop
		backup-directory restore "$NEXUS_HOME" "$BAK/files" "$NEXUS_SYSTEM_USER" &&
		service-wrapper liferay start
	;;
	*)
		echo "Usage: $SCRIPT_NAME {dump|restore} DIRECTORY"
		exit 1
	;;
esac
