#!/bin/bash
###################################
# Usage: backup {dump|restore ID} #
# Must be run as root             #
###################################

if [ $(id -u) != '0' ]; then
	echo 'You need root privileges to run this script'
	exit 1
fi

SCRIPT_NAME="$0"
ACTION="$1"

function showUsageAndExit {
	echo "Usage: $SCRIPT_NAME {dump|restore ID}"
	exit 2
}

case "$ACTION" in
	dump)
		ACTION_LABEL="Backing up"
		BACKUP_ID=$(date +'%y-%m-%d_%H-%M')
	;;
	restore)
		if [[ -z "$2" ]]; then
			showUsageAndExit
		fi

		ACTION_LABEL="Restoring"
		BACKUP_ID="$2"
	;;
	*)
		showUsageAndExit
	;;
esac

BACKUP_INSTALL_DIR=$(dirname $(readlink -f "$0"))
TMP_DIR="/tmp/$(cat /dev/urandom | tr -cd 'a-f0-9' | head -c 32)"
scriptError=0

if [ -z "$BACKUP_DIR" ]; then
	BACKUP_DIR='<%=@backupDir%>'
fi

echo "$ACTION_LABEL $BACKUP_DIR/*/$BACKUP_ID"

mkdir $TMP_DIR

for SCRIPT_FILE in $(ls "$BACKUP_INSTALL_DIR/tasks" | grep -P "\.sh"); do
	TASK_NAME=${SCRIPT_FILE#backup-}
	TASK_NAME=${TASK_NAME%.sh}

	echo "* $ACTION_LABEL $scriptName ..."

	TASK_BACKUP_DIR="$BACKUP_DIR/$TASK_NAME"
	BACKUP_ARCHIVE="$TASK_BACKUP_DIR/$BACKUP_ID.tar.bz2"
	CUR_TMP_DIR="$TMP_DIR/$BACKUP_ID"
	mkdir -p $TASK_BACKUP_DIR

	if [ $ACTION = 'dump' ]; then
		mkdir $CUR_TMP_DIR
		chmod 777 $CUR_TMP_DIR
	else
		cd $TMP_DIR
		tar xjvf $BACKUP_ARCHIVE
	fi

	sh "$BACKUP_INSTALL_DIR/tasks/$SCRIPT_FILE" $ACTION $CUR_TMP_DIR
	status=$?

	if [ $status = '0' ]; then
		if [ $ACTION = 'dump' ]; then
			cd $TMP_DIR
			tar cjvf $BACKUP_ARCHIVE $BACKUP_ID
		fi

		echo "  ... finished"
	else
		scriptError=3
		echo "  ... $scriptName $ACTION failed" 2>&1
	fi

	rm -rf $CUR_TMP_DIR
done

rm -rf $TMP_DIR

if [ $scriptError = '0' ]; then
	echo "Finished successfully"
else
	echo "Finished with error(s)"
fi

exit $scriptError
