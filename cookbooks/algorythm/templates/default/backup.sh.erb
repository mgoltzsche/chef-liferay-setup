#!/bin/bash
###################################
# Usage: backup {dump|restore ID} #
# Must be run as root             #
###################################

if [ $(id -u) != '0' ]; then
	echo 'You need root privileges to run this script'
	exit 1
fi

if [ -z "$BACKUP_DIR" ]; then
	BACKUP_DIR='<%=@backupDir%>'
fi

SCRIPT_NAME="$0"
ACTION="$1"

function showUsageAndExit {
	echo "Usage: $SCRIPT_NAME {dump|restore ID}"
	exit 2
}

case "$ACTION" in
	dump)
		ACTION_LABEL="Backing up"
		BACKUP_ID=$(date +'%y-%m-%d_%H-%M')
	;;
	restore)
		if [[ -z "$2" ]]; then
			showUsageAndExit
		fi

		ACTION_LABEL="Restoring"
		BACKUP_ID="$2"
	;;
	*)
		showUsageAndExit
	;;
esac

BACKUP_INSTALL_DIR=$(dirname $(readlink -f "$0"))
PATH="$PATH:$BACKUP_INSTALL_DIR/bin"
TMP_DIR="/tmp/$(cat /dev/urandom | tr -cd 'a-f0-9' | head -c 32)"
SCRIPT_ERROR=0

function runBackupTask {
	SCRIPT_FILE="$1"
	TASK_NAME=${SCRIPT_FILE#backup-}
	TASK_NAME=${TASK_NAME%.sh}

	echo "* $ACTION_LABEL $scriptName ..."

	TASK_BACKUP_DIR="$BACKUP_DIR/$TASK_NAME"
	BACKUP_ARCHIVE="$TASK_BACKUP_DIR/$BACKUP_ID.tar.bz2"
	CUR_TMP_DIR="$TMP_DIR/$BACKUP_ID"
	mkdir -p $TASK_BACKUP_DIR

	if [ $ACTION = 'dump' ]; then
		mkdir $CUR_TMP_DIR
		chmod 777 $CUR_TMP_DIR
	else
		if [ ! -f $BACKUP_ARCHIVE ]; then
			echo "  ... failed: $BACKUP_ARCHIVE does not exist" 2>&1
			return 1
		fi

		cd $TMP_DIR
		tar xjf $BACKUP_ARCHIVE
		STATUS=$?

		if [ $STATUS != '0' ]; then
			echo "  ... failed: Couldn't extract $BACKUP_ARCHIVE in $TMP_DIR" 2>&1
			return 1
		fi
	fi

	sh "$BACKUP_INSTALL_DIR/tasks/$SCRIPT_FILE" $ACTION $CUR_TMP_DIR
	STATUS=$?

	if [ $STATUS = '0' ]; then
		if [ $ACTION = 'dump' ]; then
			cd $TMP_DIR
			tar cjf $BACKUP_ARCHIVE $BACKUP_ID
			STATUS=$?

			if [ $STATUS != '0' ]; then
				echo "  ... failed: Couldn't compress and save backup to $BACKUP_ARCHIVE" 2>&1
				return 1
			fi
		fi

		echo "  ... finished"
		return 0
	else
		echo "  ... $scriptName $ACTION failed" 2>&1
		return 1
	fi
}

echo "$ACTION_LABEL $BACKUP_DIR/*/$BACKUP_ID"

mkdir $TMP_DIR

for SCRIPT_FILE in $(ls "$BACKUP_INSTALL_DIR/tasks" | grep -P "\.sh"); do
	runBackupTask "$SCRIPT_FILE"
	STATUS=$?

	if [ $STATUS != '0' ]; then
		SCRIPT_ERROR=3
	fi

	rm -rf $TMP_DIR/$BACKUP_ID
done

rm -rf $TMP_DIR

if [ $SCRIPT_ERROR = '0' ]; then
	echo "Finished successfully"
else
	echo "Finished with error(s)"
fi

exit $SCRIPT_ERROR
